<!DOCTYPE html>
<html>
<head>
    <title>Server Control Panel</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <!-- TOP NAVBAR -->
    <div class="topbar">
        <h2>Server Control Panel</h2>

        <div class="menu">
            <a href="/start">Start App</a>
            <a href="/stop">Stop App</a>
            <a href="/processes">Processes</a>
            <a href="/screenshot">Screenshot</a>
            <a href="/keylogger">Web Keylogger</a>
            <a href="/webcam">Webcam</a>
            <a href="/shutdown">Shutdown</a>
            <a href="/restart">Restart</a>
        </div>
    </div>

    <div class="main">

        <h1>{{ title }}</h1>

        <!-- START/STOP APP -->
        {% if mode == "start" or mode == "stop" %}
        <form action="/control" method="POST" class="form-box">
            <label>Select App:</label>
            <select name="app">
                <option value="calculator">Calculator</option>
                <option value="notes">Notes</option>
                <option value="textedit">TextEdit</option>
                <option value="safari">Safari</option>
                <option value="terminal">Terminal</option>
                <option value="finder">Finder</option>
                <option value="preview">Preview</option>
                <option value="messages">Messages</option>
                <option value="calendar">Calendar</option>
                <option value="contacts">Contacts</option>
                <option value="mail">Mail</option>
            </select>

            <button name="action" value="{{ mode }}">
                {{ "Start App" if mode=="start" else "Stop App" }}
            </button>
        </form>
        {% endif %}

        <!-- PROCESS LIST -->
        {% if mode == "processes" %}
        <h2>Running Processes (Top 50 CPU)</h2>
        <p>Danh sách các tiến trình đang chạy trên Server:</p>
        
        <pre class="keybox" style="height: 500px;">{{ process_list }}</pre>

        <form action="/processes" method="GET">
            <button>Refresh List</button>
        </form>
        {% endif %}

        <!-- SCREENSHOT -->
        {% if mode == "screenshot" %}
        <form action="/control" method="POST">
            <input type="hidden" name="action" value="screenshot">
            <button class="danger">Take Screenshot</button>
        </form>
        {% endif %}

        <!-- KEYLOGGER -->
        {% if mode == "keylogger" %}
        <h2>Web Keylogger</h2>
        <p>Hệ thống đang ghi lại tất cả phím bạn nhấn trên trang web này.</p>

        <pre id="keylog" class="keybox">[Loading keys...]</pre>

        <script>
        document.addEventListener("keydown", function(e) {
            fetch("/logkey_web", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ key: e.key })
            });
        });

        function updateKeylog() {
            fetch("/keylogger_data")
                .then(res => res.json())
                .then(data => {
                    const pre = document.getElementById("keylog");
                    pre.textContent = data.keys;
                    pre.scrollTop = pre.scrollHeight;
                });
        }

        setInterval(updateKeylog, 30);
        updateKeylog();
        </script>
        {% endif %}

        <!-- WEBCAM -->
        {% if mode == "webcam" %}
        <h2>Record Webcam</h2>

        <form action="/control" method="POST">
            <input type="hidden" name="action" value="webcam_record">

            <label>Record Duration:</label>
            <select name="seconds">
                <option value="1">Record 1s</option>
                <option value="2">Record 2s</option>
                <option value="5">Record 5s</option>
                <option value="10">Record 10s</option>
                <option value="20">Record 20s</option>
                <option value="30">Record 30s</option>
            </select>

            <button>Start Recording</button>
        </form>
        {% endif %}

        {% if mode == "shutdown" %}
        <form action="/control" method="POST">
            <input type="hidden" name="action" value="shutdown">
            <button class="danger">Shutdown Now</button>
        </form>
        {% endif %}

        {% if mode == "restart" %}
        <form action="/control" method="POST">
            <input type="hidden" name="action" value="restart">
            <button class="danger">Restart Now</button>
        </form>
        {% endif %}

        {% if message %}
        <div class="msg">{{ message }}</div>
        {% endif %}

    </div>
</body>
</html>
